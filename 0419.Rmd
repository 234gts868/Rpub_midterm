---
title: "group 14"
output: html_document
---

```{r setup, include=FALSE}
library(readr)
library(dplyr)
library(ggplot2)


customer <- read_csv("Downloads/brazilian-ecommerce/olist_customers_dataset.csv")
#geolocation<-read_csv("Downloads/brazilian-ecommerce/olist_geolocation_dataset.csv")
item<-read_csv("Downloads/brazilian-ecommerce/olist_order_items_dataset.csv")
#order_payments<-read_csv("Downloads/brazilian-ecommerce/olist_order_payments_dataset.csv")
review<-read_csv("Downloads/brazilian-ecommerce/olist_order_reviews_dataset.csv")         
order<-read_csv("Downloads/brazilian-ecommerce/olist_orders_dataset.csv")
product<-read_csv("Downloads/brazilian-ecommerce/olist_products_dataset.csv")
seller<-read_csv("Downloads/brazilian-ecommerce/olist_sellers_dataset.csv")
translation<-read_csv("Downloads/brazilian-ecommerce/product_category_name_translation.csv")
lead<-read_csv("Downloads/marketing-funnel-olist/olist_closed_deals_dataset.csv")
review$review_score = as.factor(review$review_score)
 
# ORIS<- merge(products,order_items,by= "product_id")
# ORIS <- merge(ORIS ,order_reviews,by= "order_id")
# ORIS <- merge(ORIS,translation,by= "product_category_name")
# ORIS <-merge(ORIS,sellers,by= "seller_id")
# ORIS <-merge(ORIS,orders,by= "order_id")
# ORIS <-merge(ORIS,customer,by= "customer_id")


#ORIS$review_score=as.factor(ORIS$review_score)


```

###對延遲訂單的簡單分析
- 清除刪除重複訂單的日期

```{r}

ORIS = order %>%
  inner_join(review) %>%
  inner_join(item) %>%
  inner_join(seller)
```



- 比較估計的交付天數和交付的實際天數
```{r}
ORIS$delaydays=
  difftime(as.Date(ORIS$order_delivered_customer_date,na.rm=TRUE),
           as.Date(ORIS$order_estimated_delivery_date,na.rm=TRUE),units = "days")


```
- 每個州的分析

- 估計均值，標準差和方差
```{r}
ORIS = ORIS %>%
  filter(!is.na(delaydays))

mean(ORIS$delaydays)
sd(ORIS$delaydays)
ggplot(ORIS ,aes(delaydays)) +
  geom_histogram()

# 7294 delay
table(ORIS$delaydays>0)
```
- 檢查關鍵狀態
- 以月為單位檢查行為

`三月延遲訂單數最多`
```{r,message=FALSE}
library(lubridate)
ORIS$delay=ORIS$delaydays>0   #delay or not   
ORIS$order_purchase_timestamp=as.Date(ORIS$order_purchase_timestamp,na.rm=TRUE)

ggplot(ORIS, aes(month(ORIS$order_purchase_timestamp), fill =delay )) + geom_bar()

```



3 ,11 month delay analysis
```{r}

ORIS%>%
  filter(month(ORIS$order_purchase_timestamp)==c(3,11))






```

```{r}
ORIP = order %>%
  inner_join(review) %>%
  inner_join(item) %>%
  inner_join(product) %>%
  inner_join(translation) %>%
  left_join(ORIS,by ="order_id")
```


```{r}

sort(table(ORIP$product_category_name_english),decreasing = T)
ORIP%>%
  group_by(product_category_name_english)%>%
ggplot(aes(product_category_name_english,fill =delay)) +
  geom_bar()+ 
  coord_flip()


# draw a order plot by category
# topn =10
# by money ?

```


####當公司知道會出現一些問題（例如在2018年3月）以避免一些損失和客戶的挫折時，可以使用這些估計的天數。




```{r}
ORIS$delaydays = as.numeric(ORIS$delaydays)

ORIS_delay=ORIS %>%
  filter(delaydays<50) %>%
  filter(delaydays>0)%>%
   mutate( binwidth = delaydays %/% 5 )
# mutate( binwidth = paste(as.character((ORIS$A %/% 5)*5-4) ,"-", as.character((ORIS$A %/% 5)*5)))
#w = paste(as.character((ORIS$B %/% 5)*5-4) ,zzz, as.character((ORIS$B %/% 5)*5))
#w

#  percentage of score ~ day
ORIS_delay%>%
ggplot(aes(binwidth, fill=review_score)) +
  geom_bar(position = 'fill') +
  geom_text(data = . %>% 
              group_by(binwidth, review_score) %>%
              tally() %>%
              mutate(p = n / sum(n)) %>%
              ungroup(),
            aes(y = p, label = scales::percent(p)),
            position = position_stack(vjust = 0.5),
            show.legend = FALSE)
## 
ORIS_nodelay=ORIS %>%
  filter(delaydays <0)%>%
  mutate( binwidth = delaydays %/% 5 )


ORIS_nodelay%>%
  ggplot(aes(binwidth, fill=review_score)) +
  geom_bar(position = 'fill') +
  geom_text(data = . %>% 
              group_by(binwidth, review_score) %>%
              tally() %>%
              mutate(p = n / sum(n)) %>%
              ungroup(),
            aes(y = p, label = scales::percent(p)),
            position = position_stack(vjust = 0.5),
            show.legend = FALSE)

```